<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Garrison - Caixa Registradora</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Special+Elite&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              western: ['Rye', 'serif'],
              typewriter: ['Special Elite', 'monospace'],
              ledger: ['Courier Prime', 'monospace'],
            },
            colors: {
              rdr: {
                red: '#8a0303',
                dark: '#1a1a1a',
                paper: '#d8cba8',
                paperDark: '#c4b694',
                ink: '#2b2b2b',
              }
            }
          }
        }
      }
    </script>

    <style>
      body { background-color: #1a1a1a; color: #d8cba8; }
      
      /* Scrollbar Personalizada */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #2b2b2b; }
      ::-webkit-scrollbar-thumb { background: #8a0303; border-radius: 2px; }
      ::-webkit-scrollbar-thumb:hover { background: #a30404; }

      /* Efeitos Visuais */
      .grunge-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
        z-index: 50;
      }
      
      .receipt-paper {
        background: #d8cba8;
        background-image: repeating-linear-gradient(#d8cba8 0px, #d8cba8 24px, #c4b694 25px);
        box-shadow: 8px 8px 15px rgba(0,0,0,0.5);
      }

      /* Utilitários */
      input[type=number]::-webkit-inner-spin-button, 
      input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
      
      .dashed-box { border: 2px dashed rgba(43, 43, 43, 0.3); }
      
      /* Animações dos Seletores */
      .icon-btn.selected { background-color: #2b2b2b; color: #d8cba8; transform: scale(1.1); border-color: #000; }
      .color-btn.selected { border-color: #000; transform: scale(1.2); box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
      
      /* Botão de Gorjeta */
      .tip-btn.active {
        background-color: #2b2b2b;
        color: #d8cba8;
        border-color: #2b2b2b;
        box-shadow: 2px 2px 0px 0px rgba(138, 3, 3, 0.8);
        transform: translateY(-2px);
      }
    </style>
</head>
<body class="font-sans pb-10 overflow-x-hidden flex flex-col min-h-screen">

    <div class="grunge-overlay"></div>

    <header class="bg-rdr-red text-white py-6 shadow-lg border-b-4 border-black relative z-20 shrink-0">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <div class="h-16 w-16 rounded-full border-2 border-white/30 bg-black/20 flex items-center justify-center overflow-hidden shrink-0 shadow-inner hidden sm:flex transition-all" id="headerLogoContainer">
                   <i data-lucide="saloon-doors" class="w-9 h-9 text-yellow-500/90"></i> 
                </div>
                <div>
                    <h1 id="headerStoreName" class="font-western text-3xl md:text-5xl tracking-widest drop-shadow-md">The Garrison</h1>
                    <p class="font-typewriter text-xs text-white/70 tracking-widest uppercase hidden sm:block pl-1">Caixa Registradora</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="text-right hidden md:block">
                    <span class="text-xs font-western text-yellow-500/60 block">feito por Antônio Pimento</span>
                </div>
                <button onclick="toggleSettings()" class="p-2 hover:bg-black/20 rounded-full transition-colors group">
                    <i data-lucide="settings" class="w-8 h-8 text-white group-hover:rotate-90 transition-transform duration-500"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-7xl flex-grow flex flex-col lg:flex-row gap-8 relative z-10">
            
        <div class="lg:w-2/3 flex flex-col gap-6 h-full">
            
            <div class="overflow-y-auto custom-scrollbar pr-2 flex-grow min-h-[400px]" id="productsGrid">
                <div class="text-center py-20 opacity-30">
                    <i data-lucide="loader-2" class="w-10 h-10 animate-spin mx-auto mb-4"></i>
                    <p class="font-western">Carregando suprimentos...</p>
                </div>
            </div>

            <div class="bg-rdr-paper/90 border-2 border-rdr-ink/40 p-5 shadow-md rounded shrink-0">
                <div class="flex items-center gap-2 mb-3 border-b border-rdr-ink/20 pb-2">
                    <div class="p-1 rounded-full bg-rdr-paperDark border border-rdr-ink/20">
                         <i data-lucide="hand-coins" class="w-4 h-4 text-rdr-ink"></i>
                    </div>
                    <h3 class="font-western text-lg text-rdr-ink tracking-wide">Gorjeta / Serviço</h3>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
                    <div class="flex gap-2 w-full sm:w-auto overflow-x-auto pb-1 sm:pb-0" id="tipButtonsContainer">
                        </div>

                    <div class="flex-1 w-full relative">
                         <div class="absolute left-0 top-1/2 -translate-y-1/2 text-rdr-ink/50 pl-2">
                             <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                         </div>
                         <input type="number" id="fixedTipInput" placeholder="Valor Fixo" oninput="setFixedTip(this.value)" 
                         class="w-full bg-rdr-paperDark/20 border-b-2 border-rdr-ink/30 pl-8 pr-2 py-1 font-typewriter font-bold focus:outline-none focus:border-rdr-red focus:bg-rdr-paperDark/40 transition-colors">
                         <span class="absolute right-2 top-1/2 -translate-y-1/2 text-xs font-western text-rdr-ink/50 pointer-events-none">Extra</span>
                    </div>
                </div>
                <p class="text-center text-xs font-typewriter text-rdr-ink/40 mt-2 italic">"A gratidão é a memória do coração."</p>
            </div>
        </div>

        <div class="lg:w-1/3 h-auto lg:h-full sticky top-4 lg:static">
            <div id="receiptArea" class="receipt-paper text-rdr-ink p-6 font-ledger text-sm relative min-h-[600px] flex flex-col border-4 border-double border-rdr-ink/80 transform rotate-1 transition-transform hover:rotate-0 duration-300">
                
                <div id="receiptWatermark" class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-10 hidden overflow-hidden z-0">
                    <img src="" class="w-3/4 object-contain grayscale sepia mix-blend-multiply filter blur-[0.5px]">
                </div>

                <div class="relative z-10 flex flex-col h-full">
                    <div class="text-center border-b-2 border-rdr-ink pb-4 mb-4">
                        <div class="flex items-center justify-center gap-4 mb-2">
                            <img id="receiptLogo" src="" class="h-16 w-auto max-w-[80px] object-contain grayscale sepia hidden contrast-125">
                            <h2 id="receiptStoreTitle" class="font-western text-3xl uppercase tracking-widest leading-none break-words">THE GARRISON</h2>
                        </div>
                        <p class="text-xs uppercase mt-1 font-typewriter tracking-widest">Saint Denis, Lemoyne - <span id="currentDate"></span></p>
                    </div>

                    <div class="flex-grow overflow-y-auto custom-scrollbar pr-1 max-h-[50vh]" id="cartItems">
                        <div class="flex flex-col items-center justify-center h-40 text-rdr-ink/40 italic">
                            <span>Nenhum pedido anotado...</span>
                        </div>
                    </div>

                    <div class="mt-auto border-t-2 border-dashed border-rdr-ink/50 pt-4 bg-rdr-paper/30 rounded-sm">
                        
                        <div class="space-y-1 mb-4 px-2">
                            <div class="flex justify-between font-western text-lg text-rdr-ink/70">
                                <span>PRODUTOS:</span>
                                <span id="subtotalDisplay" class="font-typewriter font-bold text-rdr-ink">$0.00</span>
                            </div>
                            
                            <div class="flex justify-between font-western text-lg text-rdr-ink/70 items-center">
                                <span id="tipLabel">GORJETA:</span>
                                <span id="tipDisplay" class="font-typewriter font-bold text-rdr-ink">$0.00</span>
                            </div>
                        </div>

                        <div class="flex justify-between items-end font-western text-2xl text-rdr-ink pt-2 border-t border-rdr-ink px-2">
                            <span>TOTAL:</span>
                            <span id="totalDisplay" class="text-4xl font-typewriter font-bold text-rdr-red underline decoration-double decoration-rdr-ink/20">$0.00</span>
                        </div>
                        
                        <div class="my-6 px-4">
                             <p id="quoteDisplay" class="text-center text-sm italic opacity-70 font-typewriter leading-tight"></p>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-3 mt-4" data-html2canvas-ignore="true">
                        <button onclick="clearCart()" class="col-span-1 border-2 border-rdr-ink text-rdr-ink hover:bg-rdr-ink/10 font-western text-sm py-3 uppercase tracking-wider transition-colors" title="Limpar Pedido">
                            Amassar
                        </button>
                        <button onclick="downloadReceipt()" class="col-span-2 bg-rdr-ink text-rdr-paper border-2 border-black hover:bg-black font-western text-lg py-3 uppercase flex justify-center items-center gap-2 shadow-lg hover:scale-[1.02] transition-all">
                            <i data-lucide="download" class="w-5 h-5"></i> Passar a Régua
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="settingsModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity opacity-0 pointer-events-none">
        <div class="bg-rdr-paper w-full max-w-2xl h-[90vh] max-h-[800px] flex flex-col rounded shadow-2xl border-4 border-rdr-ink relative overflow-hidden transform scale-95 transition-transform" id="settingsModalContent">
            
            <div class="bg-rdr-red p-4 flex justify-between items-center text-white border-b-4 border-black shrink-0">
                <h2 class="font-western text-2xl tracking-widest">CONFIGURAÇÕES</h2>
                <button onclick="toggleSettings()" class="hover:text-yellow-400 transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>

            <div class="flex border-b-2 border-rdr-ink/50 bg-rdr-paperDark/30 shrink-0">
                <button onclick="switchTab('general')" id="tab-general" class="flex-1 py-4 font-western text-xl transition-colors bg-rdr-paper text-rdr-ink border-r border-rdr-ink/20">LOJA & MARCA</button>
                <button onclick="switchTab('products')" id="tab-products" class="flex-1 py-4 font-western text-xl transition-colors text-rdr-ink/50 hover:bg-rdr-paper/50">PRODUTOS (<span id="prodCount">0</span>)</button>
            </div>
            
            <div class="overflow-y-auto p-6 md:p-8 space-y-6 custom-scrollbar flex-grow bg-rdr-paper relative">
                <div class="absolute inset-0 pointer-events-none opacity-10 bg-[url('https://www.transparenttextures.com/patterns/aged-paper.png')] z-0"></div>
                
                <div id="content-general" class="space-y-8 relative z-10">
                    
                    <div class="space-y-2">
                        <label class="font-western text-xl text-rdr-ink">Nome do Estabelecimento</label>
                        <input type="text" id="confStoreName" class="w-full bg-transparent border-b-2 border-rdr-ink font-typewriter text-2xl p-2 outline-none focus:border-rdr-red placeholder-rdr-ink/30">
                    </div>

                    <div class="pt-4 border-t border-dashed border-rdr-ink/30">
                        <label class="font-western text-xl text-rdr-ink mb-4 block">Brasão / Logo</label>
                        <div class="flex flex-col sm:flex-row gap-6 items-start">
                            <div class="w-32 h-32 border-2 border-rdr-ink/30 bg-rdr-paperDark/20 flex items-center justify-center relative group rounded overflow-hidden shadow-inner">
                                <img id="confLogoPreview" class="w-full h-full object-contain hidden">
                                <div id="confLogoPlaceholder" class="flex flex-col items-center opacity-50">
                                    <i data-lucide="image" class="w-8 h-8 mb-1"></i>
                                </div>
                                <button onclick="removeLogo()" class="absolute inset-0 bg-black/60 text-white opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
                                    <i data-lucide="trash-2"></i>
                                </button>
                            </div>
                            
                            <div class="flex-1 space-y-4">
                                <input type="file" id="logoInput" accept="image/*" onchange="handleLogoUpload(this)" class="hidden">
                                <button onclick="document.getElementById('logoInput').click()" class="bg-rdr-ink text-rdr-paper px-4 py-2 font-typewriter text-sm rounded hover:bg-black flex items-center gap-2 border border-black shadow-sm transition-transform active:scale-95">
                                    <i data-lucide="upload" class="w-4 h-4"></i> Carregar Imagem
                                </button>
                                
                                <div class="space-y-2 pt-1">
                                    <label class="flex items-center gap-3 text-sm font-typewriter cursor-pointer select-none text-rdr-ink hover:text-rdr-red transition-colors">
                                        <input type="checkbox" id="confShowHeader" class="accent-rdr-red w-4 h-4"> 
                                        <span>Exibir ao lado do nome (Cabeçalho)</span>
                                    </label>
                                    <label class="flex items-center gap-3 text-sm font-typewriter cursor-pointer select-none text-rdr-ink hover:text-rdr-red transition-colors">
                                        <input type="checkbox" id="confShowWatermark" class="accent-rdr-red w-4 h-4"> 
                                        <span>Usar como Marca D'água (Fundo)</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8 pt-6 border-t border-rdr-ink/20">
                        <div class="dashed-box p-4 rounded bg-rdr-ink/5">
                            <h3 class="font-western text-lg mb-3 text-rdr-ink">Arquivos do Escritório</h3>
                            <div class="flex flex-col gap-3">
                                <button onclick="importSettingsClick()" class="flex items-center gap-2 text-sm font-typewriter hover:text-rdr-red transition-colors group">
                                    <i data-lucide="file-up" class="w-4 h-4 group-hover:-translate-y-0.5 transition-transform"></i> Importar Configurações
                                </button>
                                <button onclick="exportSettings()" class="flex items-center gap-2 text-sm font-typewriter hover:text-rdr-red transition-colors group">
                                    <i data-lucide="download" class="w-4 h-4 group-hover:translate-y-0.5 transition-transform"></i> Exportar Configurações
                                </button>
                                <input type="file" id="importInput" accept=".json" class="hidden" onchange="importSettings(this)">
                            </div>
                        </div>

                        <div class="dashed-box p-4 rounded bg-rdr-ink/5 flex flex-col justify-between border-red-900/20">
                             <h3 class="font-western text-lg mb-3 text-rdr-ink">Zona de Perigo</h3>
                             <button onclick="resetFactory()" class="text-rdr-red font-typewriter text-sm font-bold flex items-center gap-2 hover:underline">
                                <i data-lucide="rotate-ccw" class="w-4 h-4"></i> Restaurar Padrões
                             </button>
                        </div>
                    </div>
                </div>

                <div id="content-products" class="hidden space-y-8 relative z-10">
                    
                    <div class="bg-rdr-paperDark/20 p-5 border border-rdr-ink/30 rounded shadow-inner space-y-5">
                        <h3 class="font-western text-xl opacity-80">Adicionar Novo Item</h3>
                        
                        <div class="grid grid-cols-12 gap-3">
                            <div class="col-span-12 sm:col-span-5">
                                <input type="text" id="newProdName" placeholder="Nome do Item" class="w-full p-2 bg-rdr-paper border border-rdr-ink/30 rounded font-typewriter outline-none focus:border-rdr-red shadow-sm">
                            </div>
                            <div class="col-span-6 sm:col-span-3">
                                <div class="relative">
                                    <span class="absolute left-2 top-1/2 -translate-y-1/2 font-typewriter opacity-50">$</span>
                                    <input type="number" id="newProdPrice" placeholder="Preço" class="w-full p-2 pl-6 bg-rdr-paper border border-rdr-ink/30 rounded font-typewriter outline-none focus:border-rdr-red shadow-sm">
                                </div>
                            </div>
                            <div class="col-span-6 sm:col-span-4">
                                <select id="newProdCat" class="w-full p-2 bg-rdr-paper border border-rdr-ink/30 rounded font-typewriter outline-none h-full shadow-sm cursor-pointer">
                                    <option value="Bebidas">Bebidas</option>
                                    <option value="Comida">Comida</option>
                                    <option value="Suprimentos">Suprimentos</option>
                                </select>
                            </div>
                        </div>

                        <div class="dashed-box p-3 rounded bg-rdr-paper/50">
                            <label class="text-xs font-western opacity-60 uppercase mb-2 block tracking-widest">Escolha o Ícone</label>
                            <div class="flex flex-wrap gap-3" id="iconPickerGrid">
                                </div>
                        </div>

                        <div class="dashed-box p-3 rounded bg-rdr-paper/50">
                            <label class="text-xs font-western opacity-60 uppercase mb-2 block tracking-widest">Cor do Ícone</label>
                            <div class="flex gap-3 flex-wrap" id="colorPickerGrid">
                                </div>
                        </div>

                        <button onclick="addProduct()" class="w-full bg-rdr-ink text-rdr-paper py-3 font-western uppercase rounded hover:bg-black transition-all flex items-center justify-center gap-2 text-lg shadow-md active:translate-y-0.5">
                            <i data-lucide="plus"></i> Adicionar ao Catálogo
                        </button>
                    </div>

                    <div class="space-y-3 pb-4" id="confProductList">
                        </div>
                </div>
            </div>

            <div class="p-4 bg-rdr-paper border-t-2 border-rdr-ink shrink-0 flex justify-end gap-3 z-20 relative">
                 <button onclick="toggleSettings()" class="px-6 py-2 font-western text-rdr-ink border-2 border-transparent hover:border-rdr-ink/20 rounded transition-colors uppercase">Cancelar</button>
                 <button onclick="saveSettings()" class="bg-rdr-ink text-rdr-paper px-8 py-2 font-western uppercase rounded shadow-lg hover:bg-black border-2 border-black flex items-center gap-2 hover:scale-105 transition-transform">
                    <i data-lucide="save" class="w-4 h-4"></i> Salvar Alterações
                 </button>
            </div>
        </div>
    </div>

    <script>
        // === CONSTANTS ===
        // Mapped to match exactly the screenshot order and logic
        const ICONS_MAP = [
            'beer', 'glass-water', 'coffee', 'wine-off', // Bebidas
            'utensils-crossed', 'drumstick', 'carrot', 'apple', 'fish', 'wheat', // Comida
            'cigarette', 'shopping-bag', 'skull', 'star', 'heart', 'flame', 'shield', 'gem' // Suprimentos/Outros
        ];
        
        const COLORS_MAP = [
            '#2b2b2b', // Black (Default)
            '#8a0303', // Red
            '#d97706', // Amber
            '#ea580c', // Orange
            '#15803d', // Green
            '#1d4ed8', // Blue
            '#78350f', // Brown
            '#6b7280'  // Gray
        ];

        const QUOTES = [
            "Se a vida te der limões, faça uma caipirinha.",
            "Teu galeto prefere o nosso espeto.",
            "Se você bebe para esquecer... por favor pague antes.",
            "A paz vem depois da terceira dose.",
            "Se prometeu que seria só uma, não prometa de novo.",
            "Se ver que vai cair, se atira.",
            "Não toque Jaw Harp, obrigado."
        ];

        const DEFAULT_STORE_NAME = "The Garrison";
        
        // Initial Products exactly as per previous context
        const DEFAULT_PRODUCTS = [
            { id: '1', name: 'Moonshine', price: 0.55, category: 'Bebidas', icon: 'beer', color: '#d97706' },
            { id: '2', name: 'Água da bica', price: 0.00, category: 'Bebidas', icon: 'glass-water', color: '#1d4ed8' },
            { id: '3', name: 'Pão da dona Lili', price: 1.00, category: 'Comida', icon: 'wheat', color: '#2b2b2b' },
            { id: '4', name: 'Peixe frito', price: 2.00, category: 'Comida', icon: 'fish', color: '#ea580c' },
            { id: '5', name: 'Cigarros MM', price: 0.25, category: 'Suprimentos', icon: 'cigarette', color: '#6b7280' },
            { id: '6', name: 'Charuto Cubano', price: 0.75, category: 'Suprimentos', icon: 'cigarette', color: '#78350f' }
        ];

        // === STATE ===
        let state = {
            storeName: DEFAULT_STORE_NAME,
            products: JSON.parse(JSON.stringify(DEFAULT_PRODUCTS)),
            cart: {}, // { id: quantity }
            logo: null,
            showHeader: false,
            showWatermark: false,
            tipMode: 'percent', // 'percent' | 'fixed'
            tipValue: 0 // Default 0
        };

        // Temporary state for the Settings Modal
        let tempIcon = 'utensils-crossed';
        let tempColor = '#2b2b2b';

        // === INIT ===
        function init() {
            // Load from LocalStorage
            const saved = localStorage.getItem('saloon_ledger_v3');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed };
                } catch(e) { console.error("Save corrupted", e); }
            }

            // Set dynamic date
            document.getElementById('currentDate').innerText = new Date().toLocaleDateString('pt-BR');
            document.getElementById('quoteDisplay').innerText = QUOTES[Math.floor(Math.random() * QUOTES.length)];

            // Initial Renders
            setupPickers();
            renderAll();
        }

        // === RENDER ENGINE ===
        function renderAll() {
            renderHeader();
            renderProducts();
            renderTipControls();
            renderReceipt();
            
            // Re-initialize icons
            lucide.createIcons();
        }

        function renderHeader() {
            document.getElementById('headerStoreName').innerText = state.storeName;
            
            const logoContainer = document.getElementById('headerLogoContainer');
            if (state.logo && state.showHeader) {
                logoContainer.innerHTML = `<img src="${state.logo}" class="w-full h-full object-cover grayscale sepia contrast-125">`;
                logoContainer.classList.remove('hidden');
            } else {
                logoContainer.innerHTML = `<i data-lucide="saloon-doors" class="w-9 h-9 text-yellow-500/90"></i>`;
            }
        }

        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '';
            
            const categories = ['Bebidas', 'Comida', 'Suprimentos'];
            const iconsMap = { 'Bebidas': 'beer', 'Comida': 'utensils-crossed', 'Suprimentos': 'cigarette' };

            categories.forEach(cat => {
                const prods = state.products.filter(p => p.category === cat);
                if (prods.length === 0) return;

                // Category Header
                const catHeader = document.createElement('h3');
                catHeader.className = "font-western text-xl text-rdr-paper/60 border-b-2 border-rdr-paper/10 mb-4 mt-6 pb-1 uppercase tracking-widest flex items-center gap-2 select-none";
                catHeader.innerHTML = `<i data-lucide="${iconsMap[cat] || 'package'}" class="w-5 h-5"></i> ${cat}`;
                grid.appendChild(catHeader);

                // Grid Container
                const divGrid = document.createElement('div');
                divGrid.className = "grid grid-cols-1 md:grid-cols-2 gap-4";
                
                prods.forEach(p => {
                    const qty = state.cart[p.id] || 0;
                    const isSelected = qty > 0;
                    
                    const card = document.createElement('div');
                    // Style matching ProductCard.tsx + visual improvements
                    card.className = `relative p-4 border-2 transition-all duration-200 cursor-pointer select-none rounded group overflow-hidden ${isSelected ? 'bg-rdr-paper border-rdr-red transform -translate-y-1 shadow-[4px_4px_0px_0px_rgba(0,0,0,0.5)]' : 'bg-rdr-paper/90 border-rdr-ink/40 hover:border-rdr-red/60 shadow-sm'}`;
                    
                    // Click entire card to increment
                    card.onclick = () => updateCart(p.id, 1);

                    // Corner Accents (Decorations)
                    const corners = `
                        <div class="absolute top-1 left-1 w-2 h-2 border-t-2 border-l-2 border-rdr-ink/20"></div>
                        <div class="absolute top-1 right-1 w-2 h-2 border-t-2 border-r-2 border-rdr-ink/20"></div>
                        <div class="absolute bottom-1 left-1 w-2 h-2 border-b-2 border-l-2 border-rdr-ink/20"></div>
                        <div class="absolute bottom-1 right-1 w-2 h-2 border-b-2 border-r-2 border-rdr-ink/20"></div>
                    `;

                    card.innerHTML = `
                        ${corners}
                        <div class="flex items-center space-x-3 mb-4 relative z-10">
                           <div class="p-2 rounded-full border border-rdr-ink/20 transition-colors ${isSelected ? 'bg-rdr-paperDark' : 'bg-transparent'}">
                             <i data-lucide="${p.icon || 'package'}" style="color: ${p.color || '#2b2b2b'}" class="w-6 h-6"></i>
                           </div>
                           <h3 class="font-western text-lg leading-none text-rdr-ink tracking-wide pt-1">${p.name}</h3>
                        </div>
                        
                        <div class="flex justify-between items-end relative z-10">
                            <span class="font-typewriter font-bold text-rdr-red text-lg">$${p.price.toFixed(2)}</span>
                            
                            <div class="flex items-center space-x-1 bg-rdr-paperDark p-1 rounded border border-rdr-ink/20 shadow-inner" onclick="event.stopPropagation()">
                                <button onclick="updateCart('${p.id}', -1)" class="w-8 h-8 flex items-center justify-center bg-rdr-red text-white rounded-sm hover:bg-red-900 border border-black shadow-sm disabled:opacity-50 transition-colors" ${qty === 0 ? 'disabled' : ''}>
                                    <i data-lucide="minus" class="w-4 h-4"></i>
                                </button>
                                <span class="font-typewriter text-xl font-bold w-10 text-center text-rdr-ink">${qty > 0 ? qty : ''}</span>
                                <button onclick="updateCart('${p.id}', 1)" class="w-8 h-8 flex items-center justify-center bg-rdr-dark text-white rounded-sm hover:bg-black border border-black shadow-sm transition-colors">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    divGrid.appendChild(card);
                });
                grid.appendChild(divGrid);
            });
        }

        function renderTipControls() {
            const container = document.getElementById('tipButtonsContainer');
            container.innerHTML = '';
            
            // Exact percentages from the screenshot
            const percentages = [0, 5, 10, 15, 20];
            
            percentages.forEach(pct => {
                const isActive = state.tipMode === 'percent' && state.tipValue === pct;
                
                const btn = document.createElement('button');
                btn.className = `tip-btn min-w-[3.5rem] py-2 px-1 font-typewriter font-bold border-2 border-rdr-ink/40 text-rdr-ink/70 rounded transition-all duration-200 ${isActive ? 'active' : 'hover:bg-rdr-paperDark hover:text-rdr-red hover:border-rdr-red'}`;
                btn.innerHTML = pct === 0 ? 'X' : `${pct}%`;
                
                btn.onclick = () => { 
                    state.tipMode = 'percent'; 
                    state.tipValue = pct; 
                    renderAll(); 
                };
                
                container.appendChild(btn);
            });

            // Update fixed input visual state
            const fixedInput = document.getElementById('fixedTipInput');
            if (state.tipMode === 'fixed') {
                fixedInput.value = state.tipValue > 0 ? state.tipValue : '';
                fixedInput.classList.add('border-rdr-red', 'bg-rdr-paperDark/40');
                fixedInput.classList.remove('border-rdr-ink/30');
            } else {
                fixedInput.value = '';
                fixedInput.classList.remove('border-rdr-red', 'bg-rdr-paperDark/40');
                fixedInput.classList.add('border-rdr-ink/30');
            }
        }

        function setFixedTip(val) {
            state.tipMode = 'fixed';
            state.tipValue = parseFloat(val) || 0;
            // Deselect percent buttons visually handled by re-render
            renderAll();
        }

        function renderReceipt() {
            // UI References
            const subtotalEl = document.getElementById('subtotalDisplay');
            const tipDisplayEl = document.getElementById('tipDisplay');
            const tipLabelEl = document.getElementById('tipLabel');
            const totalEl = document.getElementById('totalDisplay');
            const container = document.getElementById('cartItems');

            // Header Elements
            document.getElementById('receiptStoreTitle').innerText = state.storeName;
            const receiptLogo = document.getElementById('receiptLogo');
            const watermark = document.getElementById('receiptWatermark');

            if (state.logo && state.showHeader) {
                receiptLogo.src = state.logo;
                receiptLogo.classList.remove('hidden');
            } else receiptLogo.classList.add('hidden');

            if (state.logo && state.showWatermark) {
                watermark.querySelector('img').src = state.logo;
                watermark.classList.remove('hidden');
            } else watermark.classList.add('hidden');

            // Calculation
            let subtotal = 0;
            let html = `
                <table class="w-full text-left font-typewriter text-sm">
                    <thead>
                        <tr class="border-b border-rdr-ink/30 text-rdr-ink/50 text-xs">
                            <th class="pb-1 w-10">QNT</th>
                            <th class="pb-1">ITEM</th>
                            <th class="pb-1 text-right">VALOR</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-rdr-ink/10">
            `;
            
            let hasItems = false;
            Object.entries(state.cart).forEach(([id, qty]) => {
                if (qty > 0) {
                    hasItems = true;
                    const prod = state.products.find(p => p.id === id);
                    if (prod) {
                        const total = prod.price * qty;
                        subtotal += total;
                        html += `
                            <tr class="group hover:bg-rdr-ink/5">
                                <td class="py-2 font-bold align-top">${qty}x</td>
                                <td class="py-2 uppercase align-top leading-tight">${prod.name}</td>
                                <td class="py-2 text-right align-top whitespace-nowrap">$${total.toFixed(2)}</td>
                            </tr>
                        `;
                    }
                }
            });
            html += '</tbody></table>';

            if (!hasItems) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-40 text-rdr-ink/40 italic">
                        <i data-lucide="scroll" class="w-8 h-8 mb-2 opacity-50"></i>
                        <span>Nenhum pedido anotado...</span>
                    </div>
                `;
            } else {
                container.innerHTML = html;
            }

            // Totals
            let tipAmount = 0;
            if (state.tipMode === 'percent') {
                tipAmount = subtotal * (state.tipValue / 100);
                tipLabelEl.innerText = `GORJETA (${state.tipValue}%):`;
            } else {
                tipAmount = state.tipValue;
                tipLabelEl.innerText = `GORJETA (EXTRA):`;
            }

            const finalTotal = subtotal + tipAmount;

            subtotalEl.innerText = `$${subtotal.toFixed(2)}`;
            tipDisplayEl.innerText = `+ $${tipAmount.toFixed(2)}`;
            totalEl.innerText = `$${finalTotal.toFixed(2)}`;
        }

        // === ACTIONS ===
        function updateCart(id, change) {
            if (!state.cart[id]) state.cart[id] = 0;
            state.cart[id] += change;
            if (state.cart[id] < 0) state.cart[id] = 0;
            saveState(); // Auto-save on change
            renderAll();
        }

        function clearCart() {
            if(Object.keys(state.cart).length > 0) {
                 // Simple animation
                 const paper = document.getElementById('receiptArea');
                 paper.style.transform = 'scale(0.9) rotate(5deg)';
                 setTimeout(() => {
                     state.cart = {};
                     state.tipMode = 'percent';
                     state.tipValue = 0;
                     saveState();
                     renderAll();
                     paper.style.transform = ''; // reset
                 }, 200);
            }
        }

        function downloadReceipt() {
            const element = document.getElementById('receiptArea');
            // Slight visual tweak for print
            element.style.transform = 'none';
            element.style.borderRadius = '0';
            
            html2canvas(element, {
                scale: 2, // High res
                backgroundColor: '#d8cba8', // Enforce paper color
                useCORS: true,
                ignoreElements: (el) => el.getAttribute('data-html2canvas-ignore') === 'true'
            }).then(canvas => {
                const link = document.createElement('a');
                const safeName = state.storeName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                link.download = `${safeName}_recibo_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                // Reset visual
                element.style.borderRadius = ''; 
                element.style.transform = ''; 
            }).catch(err => {
                alert("Erro ao gerar imagem: " + err);
            });
        }

        function saveState() {
            localStorage.setItem('saloon_ledger_v3', JSON.stringify(state));
        }

        // === SETTINGS MODAL LOGIC ===
        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            const content = document.getElementById('settingsModalContent');
            const isHidden = modal.classList.contains('hidden');
            
            if (isHidden) {
                // Open
                modal.classList.remove('hidden');
                // Small delay to allow display block to render before opacity transition
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0', 'pointer-events-none');
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                });

                // Populate Fields
                document.getElementById('confStoreName').value = state.storeName;
                document.getElementById('confShowHeader').checked = state.showHeader;
                document.getElementById('confShowWatermark').checked = state.showWatermark;
                document.getElementById('prodCount').innerText = state.products.length;
                
                if(state.logo) {
                    document.getElementById('confLogoPreview').src = state.logo;
                    document.getElementById('confLogoPreview').classList.remove('hidden');
                    document.getElementById('confLogoPlaceholder').classList.add('hidden');
                } else {
                    document.getElementById('confLogoPreview').classList.add('hidden');
                    document.getElementById('confLogoPlaceholder').classList.remove('hidden');
                }

                switchTab('general'); // Default tab
                renderConfProductList();
            } else {
                // Close
                modal.classList.add('opacity-0', 'pointer-events-none');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        function switchTab(tabName) {
            // Reset Styles
            ['general', 'products'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                const div = document.getElementById(`content-${t}`);
                
                if (t === tabName) {
                    btn.classList.add('bg-rdr-paper', 'text-rdr-ink', 'border-r-2', 'border-l-2', 'border-t-2', 'border-b-0', 'border-rdr-ink/20', 'font-bold');
                    btn.classList.remove('text-rdr-ink/50', 'hover:bg-rdr-paper/50');
                    div.classList.remove('hidden');
                } else {
                    btn.classList.remove('bg-rdr-paper', 'text-rdr-ink', 'border-r-2', 'border-l-2', 'border-t-2', 'border-b-0', 'font-bold');
                    btn.classList.add('text-rdr-ink/50', 'hover:bg-rdr-paper/50');
                    div.classList.add('hidden');
                }
            });
        }

        // --- PICKERS SETUP ---
        function setupPickers() {
            const iconGrid = document.getElementById('iconPickerGrid');
            iconGrid.innerHTML = '';
            
            ICONS_MAP.forEach(icon => {
                const btn = document.createElement('button');
                btn.className = "icon-btn w-10 h-10 flex items-center justify-center rounded border border-transparent hover:bg-black/10 transition-all text-rdr-ink";
                btn.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i>`;
                btn.onclick = () => selectIcon(btn, icon);
                
                if(icon === tempIcon) {
                    btn.classList.add('selected');
                }
                iconGrid.appendChild(btn);
            });

            const colorGrid = document.getElementById('colorPickerGrid');
            colorGrid.innerHTML = '';

            COLORS_MAP.forEach(color => {
                const btn = document.createElement('button');
                btn.className = "color-btn w-8 h-8 rounded-full border-2 border-transparent transition-all";
                btn.style.backgroundColor = color;
                btn.onclick = () => selectColor(btn, color);
                
                if(color === tempColor) {
                    btn.classList.add('selected');
                    btn.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-white mx-auto"></i>';
                }
                colorGrid.appendChild(btn);
            });
        }

        function selectIcon(btn, icon) {
            tempIcon = icon;
            document.querySelectorAll('.icon-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            lucide.createIcons();
        }

        function selectColor(btn, color) {
            tempColor = color;
            document.querySelectorAll('.color-btn').forEach(b => {
                b.classList.remove('selected');
                b.innerHTML = '';
            });
            btn.classList.add('selected');
            btn.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-white mx-auto"></i>';
            lucide.createIcons();
        }

        // --- PRODUCT MANAGEMENT ---
        function addProduct() {
            const name = document.getElementById('newProdName').value;
            const price = parseFloat(document.getElementById('newProdPrice').value);
            const cat = document.getElementById('newProdCat').value;
            
            if (name && !isNaN(price)) {
                state.products.push({ 
                    id: `custom_${Date.now()}`, 
                    name, 
                    price, 
                    category: cat, 
                    icon: tempIcon, 
                    color: tempColor 
                });
                
                // Clear Inputs
                document.getElementById('newProdName').value = '';
                document.getElementById('newProdPrice').value = '';
                
                document.getElementById('prodCount').innerText = state.products.length;
                renderConfProductList();
                renderAll(); // Updates background grid instantly
            } else {
                alert("Preencha o nome e o preço corretamente.");
            }
        }

        function renderConfProductList() {
            const list = document.getElementById('confProductList');
            list.innerHTML = '';
            
            if (state.products.length === 0) {
                list.innerHTML = '<p class="text-center text-rdr-ink/50 py-4 font-typewriter">Nenhum produto cadastrado.</p>';
                return;
            }

            state.products.forEach((p, index) => {
                const item = document.createElement('div');
                item.className = "flex items-center gap-3 p-3 bg-white/40 rounded border border-rdr-ink/10 hover:bg-white/60 transition-colors";
                item.innerHTML = `
                    <div class="p-2 rounded-full bg-rdr-paperDark border border-rdr-ink/10">
                        <i data-lucide="${p.icon || 'package'}" style="color:${p.color || '#000'}" class="w-4 h-4"></i>
                    </div>
                    <div class="flex-1 font-typewriter">
                        <div class="font-bold text-rdr-ink">${p.name}</div>
                        <div class="text-xs opacity-60 uppercase">${p.category}</div>
                    </div>
                    <div class="font-bold text-rdr-red font-typewriter text-lg">$${p.price.toFixed(2)}</div>
                    <button onclick="removeProduct(${index})" class="p-2 text-rdr-ink/40 hover:text-rdr-red hover:bg-red-100 rounded transition-colors" title="Excluir">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                list.appendChild(item);
            });
            lucide.createIcons();
        }

        function removeProduct(index) {
            if(confirm('Remover este item do catálogo?')) {
                const prodId = state.products[index].id;
                state.products.splice(index, 1);
                // Remove from cart if exists
                if(state.cart[prodId]) delete state.cart[prodId];
                
                document.getElementById('prodCount').innerText = state.products.length;
                renderConfProductList();
                renderAll();
            }
        }

        // --- LOGO HANDLING ---
        function handleLogoUpload(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    state.logo = e.target.result;
                    document.getElementById('confLogoPreview').src = state.logo;
                    document.getElementById('confLogoPreview').classList.remove('hidden');
                    document.getElementById('confLogoPlaceholder').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function removeLogo() {
            state.logo = null;
            document.getElementById('confLogoPreview').classList.add('hidden');
            document.getElementById('confLogoPlaceholder').classList.remove('hidden');
            document.getElementById('logoInput').value = "";
        }

        // --- IMPORT / EXPORT / RESET ---
        function exportSettings() {
            const blob = new Blob([JSON.stringify(state, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `the_garrison_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importSettingsClick() {
            document.getElementById('importInput').click();
        }

        function importSettings(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (confirm("Isso substituirá suas configurações atuais. Continuar?")) {
                        state = { ...state, ...data };
                        saveState();
                        toggleSettings();
                        renderAll();
                        alert("Backup restaurado com sucesso!");
                    }
                } catch(err) { alert("Arquivo inválido!"); }
                input.value = ''; // reset
            }
            reader.readAsText(file);
        }

        function resetFactory() {
            if(confirm("ATENÇÃO: Isso apagará todos os produtos personalizados e configurações. Voltar ao padrão?")) {
                localStorage.removeItem('saloon_ledger_v3');
                location.reload();
            }
        }
        
        // --- FINAL SAVE ---
        function saveSettings() {
            state.storeName = document.getElementById('confStoreName').value;
            state.showHeader = document.getElementById('confShowHeader').checked;
            state.showWatermark = document.getElementById('confShowWatermark').checked;
            
            saveState();
            toggleSettings();
            renderAll();
        }

        // Start
        init();

    </script>
</body>
</html>
