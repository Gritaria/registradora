<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saloon Ledger 1899</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Special+Elite&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              western: ['Rye', 'serif'],
              typewriter: ['Special Elite', 'monospace'],
              ledger: ['Courier Prime', 'monospace'],
            },
            colors: {
              rdr: {
                red: '#8a0303',
                dark: '#1a1a1a',
                paper: '#d8cba8',
                paperDark: '#c4b694',
                ink: '#2b2b2b',
              }
            }
          }
        }
      }
    </script>

    <style>
      body { background-color: #1a1a1a; color: #d8cba8; }
      
      /* Scrollbar */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #2b2b2b; }
      ::-webkit-scrollbar-thumb { background: #8a0303; border-radius: 2px; }
      
      .grunge-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
        z-index: 50;
      }
      
      .receipt-paper {
        background: #d8cba8;
        background-image: repeating-linear-gradient(#d8cba8 0px, #d8cba8 24px, #c4b694 25px);
        box-shadow: 8px 8px 15px rgba(0,0,0,0.5);
      }
      
      /* Utilitário para esconder input number arrows */
      input[type=number]::-webkit-inner-spin-button, 
      input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="font-sans pb-20 md:pb-0 overflow-x-hidden">

    <div class="grunge-overlay"></div>

    <header class="bg-rdr-red text-white py-6 shadow-lg border-b-4 border-black relative z-20">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <div class="h-16 w-16 rounded-full border-2 border-white/30 bg-black/20 flex items-center justify-center overflow-hidden shrink-0 shadow-inner hidden sm:flex" id="headerLogoContainer">
                   <i data-lucide="saloon-doors" class="w-9 h-9 text-yellow-500/90"></i> 
                </div>
                <div>
                    <h1 id="headerStoreName" class="font-western text-2xl md:text-5xl tracking-widest drop-shadow-md">The Garrison</h1>
                    <p class="font-typewriter text-xs md:text-sm text-white/70 tracking-widest uppercase hidden sm:block">Caixa Registradora</p>
                </div>
            </div>
            <button onclick="toggleSettings()" class="p-2 hover:bg-black/20 rounded-full transition-colors">
                <i data-lucide="settings" class="w-6 h-6 md:w-8 md:h-8 text-white"></i>
            </button>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-7xl lg:h-[calc(100vh-120px)]">
        <div class="flex flex-col lg:flex-row gap-8 h-full">
            
            <div class="lg:w-2/3 overflow-y-auto custom-scrollbar pr-2 pb-20 lg:pb-0" id="productsGrid">
                </div>

            <div class="lg:w-1/3 h-auto lg:h-full sticky top-4 lg:static">
                <div id="receiptArea" class="receipt-paper text-rdr-ink p-6 font-ledger text-sm relative min-h-[500px] flex flex-col border-4 border-double border-rdr-ink/80">
                    
                    <div id="receiptWatermark" class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-10 hidden overflow-hidden z-0">
                        <img src="" class="w-3/4 object-contain grayscale sepia mix-blend-multiply">
                    </div>

                    <div class="relative z-10 flex flex-col h-full">
                        <div class="text-center border-b-2 border-rdr-ink pb-4 mb-4">
                            <div class="flex items-center justify-center gap-4">
                                <img id="receiptLogo" src="" class="h-12 w-auto object-contain grayscale sepia hidden">
                                <h2 id="receiptStoreTitle" class="font-western text-2xl uppercase tracking-widest">THE GARRISON</h2>
                            </div>
                            <p class="text-xs uppercase mt-1">Registro de Vendas - <span id="currentDate"></span></p>
                        </div>

                        <div class="flex-grow space-y-2 overflow-y-auto custom-scrollbar max-h-[40vh]" id="cartItems">
                            <div class="text-center text-rdr-ink/40 italic py-10">Nenhum pedido anotado...</div>
                        </div>

                        <div class="mt-auto border-t-2 border-dashed border-rdr-ink/30 pt-4 bg-rdr-paper/50">
                            <div class="flex justify-between font-western text-lg text-rdr-ink/70">
                                <span>Produtos:</span>
                                <span id="subtotalDisplay">$0.00</span>
                            </div>
                            
                            <div class="flex justify-between items-center py-2" data-html2canvas-ignore="true">
                                <span class="font-western text-lg">Gorjeta:</span>
                                <div class="flex gap-2 items-center">
                                    <select id="tipMode" onchange="renderReceipt()" class="bg-transparent border-b border-rdr-ink text-sm outline-none font-typewriter font-bold">
                                        <option value="percent">%</option>
                                        <option value="fixed">$</option>
                                    </select>
                                    <input type="number" id="tipValue" value="10" onchange="renderReceipt()" class="w-16 bg-transparent border-b border-rdr-ink text-right font-typewriter font-bold outline-none">
                                </div>
                            </div>

                            <div class="flex justify-between font-western text-lg text-rdr-ink/70">
                                <span id="tipLabel">Gorjeta:</span>
                                <span id="tipDisplay">$0.00</span>
                            </div>

                            <div class="flex justify-between font-western text-2xl text-rdr-ink mt-2 pt-2 border-t border-rdr-ink">
                                <span>TOTAL:</span>
                                <span id="totalDisplay" class="text-rdr-red font-bold underline decoration-double">$0.00</span>
                            </div>
                            
                            <p id="quoteDisplay" class="text-center text-xs italic mt-4 opacity-70 font-typewriter"></p>
                        </div>

                        <div class="grid grid-cols-3 gap-2 mt-4" data-html2canvas-ignore="true">
                            <button onclick="clearCart()" class="col-span-1 border-2 border-rdr-ink text-rdr-ink hover:bg-rdr-ink/10 font-western text-sm py-2 uppercase">
                                Limpar
                            </button>
                            <button onclick="downloadReceipt()" class="col-span-2 bg-rdr-ink text-rdr-paper border-2 border-black hover:bg-black font-western text-sm py-2 uppercase flex justify-center items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i> Passar a Régua
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="settingsModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-rdr-paper w-full max-w-2xl max-h-[90vh] flex flex-col rounded border-4 border-rdr-ink relative">
            <div class="bg-rdr-red p-4 flex justify-between items-center text-white border-b-4 border-black">
                <h2 class="font-western text-xl tracking-widest">CONFIGURAÇÕES</h2>
                <button onclick="toggleSettings()"><i data-lucide="x"></i></button>
            </div>
            
            <div class="overflow-y-auto p-6 space-y-6 custom-scrollbar">
                <div>
                    <label class="font-western block text-lg">Nome do Estabelecimento</label>
                    <input type="text" id="confStoreName" class="w-full bg-transparent border-b-2 border-rdr-ink font-typewriter text-xl p-2 outline-none">
                </div>

                <div class="border-t border-dashed border-rdr-ink/30 pt-4">
                    <label class="font-western block text-lg mb-2">Logotipo</label>
                    <div class="flex gap-4 items-center">
                        <div class="w-20 h-20 border border-rdr-ink/30 bg-black/10 flex items-center justify-center overflow-hidden">
                            <img id="confLogoPreview" class="w-full h-full object-contain hidden">
                            <span id="confLogoPlaceholder" class="text-xs text-center opacity-50">Sem Logo</span>
                        </div>
                        <div class="flex-1 space-y-2">
                            <input type="file" id="logoInput" accept="image/*" onchange="handleLogoUpload(this)" class="block w-full text-sm text-rdr-ink file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-rdr-ink file:text-rdr-paper file:font-western cursor-pointer">
                            <div class="flex gap-4">
                                <label class="flex items-center gap-2 text-sm font-typewriter cursor-pointer">
                                    <input type="checkbox" id="confShowHeader" class="accent-rdr-red"> Mostrar no Cabeçalho
                                </label>
                                <label class="flex items-center gap-2 text-sm font-typewriter cursor-pointer">
                                    <input type="checkbox" id="confShowWatermark" class="accent-rdr-red"> Marca D'água
                                </label>
                            </div>
                             <button onclick="removeLogo()" class="text-xs text-red-700 underline">Remover Logo</button>
                        </div>
                    </div>
                </div>

                <div class="border-t border-dashed border-rdr-ink/30 pt-4">
                    <h3 class="font-western text-lg mb-2">Adicionar Produto</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-2 bg-rdr-paperDark/30 p-3 rounded">
                        <input type="text" id="newProdName" placeholder="Nome" class="p-2 bg-white/50 border border-rdr-ink/20 rounded font-typewriter">
                        <input type="number" id="newProdPrice" placeholder="$ Preço" class="p-2 bg-white/50 border border-rdr-ink/20 rounded font-typewriter">
                        <select id="newProdCat" class="p-2 bg-white/50 border border-rdr-ink/20 rounded font-typewriter">
                            <option value="Bebidas">Bebidas</option>
                            <option value="Comida">Comida</option>
                            <option value="Suprimentos">Suprimentos</option>
                        </select>
                        <button onclick="addProduct()" class="bg-rdr-ink text-white font-western uppercase rounded hover:bg-black transition">Adicionar</button>
                    </div>
                    
                    <div class="mt-4 space-y-2 max-h-40 overflow-y-auto" id="confProductList">
                        </div>
                </div>
            </div>

            <div class="p-4 bg-rdr-paperDark/20 border-t border-rdr-ink flex justify-between items-center">
                 <button onclick="resetFactory()" class="text-red-700 font-typewriter text-xs underline">Restaurar Padrão</button>
                 <button onclick="saveSettings()" class="bg-rdr-red text-white px-6 py-2 font-western uppercase rounded shadow hover:bg-red-900 border border-black">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        // === DADOS PADRÃO ===
        const DEFAULT_STORE = "The Garrison";
        const DEFAULT_PRODUCTS = [
            { id: '1', name: 'Moonshine', price: 0.55, category: 'Bebidas', icon: 'beer' },
            { id: '2', name: 'Água da bica', price: 0.00, category: 'Bebidas', icon: 'glass-water' },
            { id: '3', name: 'Pão da dona Lili', price: 1.00, category: 'Comida', icon: 'wheat' },
            { id: '4', name: 'Peixe frito', price: 2.00, category: 'Comida', icon: 'fish' },
            { id: '5', name: 'Cigarros MM', price: 0.25, category: 'Suprimentos', icon: 'cigarette' }
        ];
        const QUOTES = [
            "Se a vida te der limões, faça uma caipirinha.",
            "Fiado só amanhã.",
            "Não atire no pianista.",
            "A gratidão é a memória do coração.",
            "Beba com moderação, pague com pressa."
        ];

        // === ESTADO DO APP ===
        let state = {
            storeName: DEFAULT_STORE,
            products: JSON.parse(JSON.stringify(DEFAULT_PRODUCTS)),
            cart: {}, // { 'id': qtd }
            logo: null,
            showHeader: false,
            showWatermark: false,
            tipMode: 'percent', // 'percent' ou 'fixed'
            tipValue: 10
        };

        // === INICIALIZAÇÃO ===
        function init() {
            // Carregar do LocalStorage
            const saved = localStorage.getItem('saloon_state');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Merge cuidadoso para não quebrar se adicionar novos campos futuramente
                    state = { ...state, ...parsed };
                } catch(e) { console.error("Erro ao carregar save", e); }
            }
            
            document.getElementById('currentDate').innerText = new Date().toLocaleDateString();
            document.getElementById('quoteDisplay').innerText = QUOTES[Math.floor(Math.random() * QUOTES.length)];
            
            renderAll();
        }

        function saveState() {
            localStorage.setItem('saloon_state', JSON.stringify(state));
            renderAll();
        }

        // === RENDERIZAÇÃO ===
        function renderAll() {
            renderHeader();
            renderProducts();
            renderReceipt();
            lucide.createIcons(); // Atualiza ícones
        }

        function renderHeader() {
            document.getElementById('headerStoreName').innerText = state.storeName;
            
            const logoContainer = document.getElementById('headerLogoContainer');
            if (state.logo && state.showHeader) {
                logoContainer.innerHTML = `<img src="${state.logo}" class="w-full h-full object-cover grayscale sepia">`;
                logoContainer.classList.remove('hidden');
            } else {
                logoContainer.innerHTML = `<i data-lucide="saloon-doors" class="w-9 h-9 text-yellow-500/90"></i>`;
                // Opcional: esconder se não tiver logo
            }
        }

        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '';
            
            // Agrupar por categoria
            const categories = ['Bebidas', 'Comida', 'Suprimentos'];
            
            categories.forEach(cat => {
                const prods = state.products.filter(p => p.category === cat);
                if (prods.length === 0) return;

                const catHeader = document.createElement('h3');
                catHeader.className = "font-western text-xl text-rdr-paper/60 border-b-2 border-rdr-paper/10 mb-4 mt-6 pb-1 uppercase tracking-widest flex items-center gap-2";
                catHeader.innerHTML = cat;
                grid.appendChild(catHeader);

                const divGrid = document.createElement('div');
                divGrid.className = "grid grid-cols-1 md:grid-cols-2 gap-4";
                
                prods.forEach(p => {
                    const qty = state.cart[p.id] || 0;
                    const isSelected = qty > 0;
                    
                    const card = document.createElement('div');
                    card.className = `relative p-4 border-2 transition-all duration-200 cursor-pointer select-none rounded ${isSelected ? 'bg-rdr-paper border-rdr-red transform -translate-y-1 shadow-lg text-rdr-ink' : 'bg-rdr-paper/90 border-rdr-ink/40 text-rdr-ink hover:border-rdr-red/60'}`;
                    card.onclick = () => updateCart(p.id, 1); // Clica no card = +1

                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-western text-lg tracking-wide">${p.name}</h4>
                        </div>
                        <div class="flex justify-between items-end mt-2">
                            <span class="font-typewriter font-bold text-rdr-red text-lg">$${p.price.toFixed(2)}</span>
                            <div class="flex items-center space-x-2 bg-rdr-paperDark p-1 rounded border border-rdr-ink/20 shadow-inner" onclick="event.stopPropagation()">
                                <button onclick="updateCart('${p.id}', -1)" class="w-8 h-8 flex items-center justify-center bg-rdr-red text-white rounded hover:bg-red-900 font-bold" ${qty === 0 ? 'disabled style="opacity:0.5"' : ''}>-</button>
                                <span class="font-typewriter text-xl font-bold w-8 text-center text-rdr-ink">${qty}</span>
                                <button onclick="updateCart('${p.id}', 1)" class="w-8 h-8 flex items-center justify-center bg-rdr-dark text-white rounded hover:bg-black font-bold">+</button>
                            </div>
                        </div>
                    `;
                    divGrid.appendChild(card);
                });
                grid.appendChild(divGrid);
            });
        }

        function renderReceipt() {
            // UI Update
            const storeTitle = document.getElementById('receiptStoreTitle');
            const receiptLogo = document.getElementById('receiptLogo');
            const watermark = document.getElementById('receiptWatermark');
            const watermarkImg = watermark.querySelector('img');

            storeTitle.innerText = state.storeName;

            // Logo Header na Nota
            if (state.logo && state.showHeader) {
                receiptLogo.src = state.logo;
                receiptLogo.classList.remove('hidden');
            } else {
                receiptLogo.classList.add('hidden');
            }

            // Watermark na Nota
            if (state.logo && state.showWatermark) {
                watermarkImg.src = state.logo;
                watermark.classList.remove('hidden');
            } else {
                watermark.classList.add('hidden');
            }

            // Itens
            const container = document.getElementById('cartItems');
            const subtotalEl = document.getElementById('subtotalDisplay');
            const tipDisplayEl = document.getElementById('tipDisplay');
            const tipLabelEl = document.getElementById('tipLabel');
            const totalEl = document.getElementById('totalDisplay');

            // Ler inputs de gorjeta
            const uiTipMode = document.getElementById('tipMode').value;
            const uiTipVal = parseFloat(document.getElementById('tipValue').value) || 0;
            state.tipMode = uiTipMode;
            state.tipValue = uiTipVal;

            let subtotal = 0;
            let html = '<table class="w-full text-left font-typewriter text-sm"><thead><tr class="border-b border-rdr-ink/30 opacity-60"><th>QNT</th><th>ITEM</th><th class="text-right">$$</th></tr></thead><tbody class="divide-y divide-rdr-ink/10">';
            
            let hasItems = false;
            Object.entries(state.cart).forEach(([id, qty]) => {
                if (qty > 0) {
                    hasItems = true;
                    const prod = state.products.find(p => p.id === id);
                    if (prod) {
                        const total = prod.price * qty;
                        subtotal += total;
                        html += `<tr><td class="py-2 font-bold">${qty}x</td><td class="py-2 uppercase">${prod.name}</td><td class="py-2 text-right">$${total.toFixed(2)}</td></tr>`;
                    }
                }
            });
            html += '</tbody></table>';

            if (!hasItems) {
                container.innerHTML = '<div class="text-center text-rdr-ink/40 italic py-10">Nenhum pedido anotado...</div>';
            } else {
                container.innerHTML = html;
            }

            // Cálculos Finais
            let tipAmount = 0;
            if (uiTipMode === 'percent') {
                tipAmount = subtotal * (uiTipVal / 100);
                tipLabelEl.innerText = `Gorjeta (${uiTipVal}%)`;
            } else {
                tipAmount = uiTipVal;
                tipLabelEl.innerText = `Gorjeta (Fixa)`;
            }

            subtotalEl.innerText = `$${subtotal.toFixed(2)}`;
            tipDisplayEl.innerText = `$${tipAmount.toFixed(2)}`;
            totalEl.innerText = `$${(subtotal + tipAmount).toFixed(2)}`;
        }

        // === LÓGICA DE AÇÃO ===
        function updateCart(id, change) {
            if (!state.cart[id]) state.cart[id] = 0;
            state.cart[id] += change;
            if (state.cart[id] < 0) state.cart[id] = 0;
            renderAll(); // Re-renderiza tudo para atualizar totais
        }

        function clearCart() {
            if(confirm("Deseja realmente limpar o pedido atual?")) {
                state.cart = {};
                renderAll();
            }
        }

        function downloadReceipt() {
            const element = document.getElementById('receiptArea');
            
            // Usar html2canvas
            html2canvas(element, {
                scale: 2,
                backgroundColor: '#d8cba8', // Garante cor de fundo do papel
                ignoreElements: (el) => el.getAttribute('data-html2canvas-ignore') === 'true'
            }).then(canvas => {
                const link = document.createElement('a');
                const safeName = state.storeName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                link.download = `${safeName}_recibo_${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        // === CONFIGURAÇÕES ===
        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            const isHidden = modal.classList.contains('hidden');
            
            if (isHidden) {
                // Preencher valores atuais
                document.getElementById('confStoreName').value = state.storeName;
                document.getElementById('confShowHeader').checked = state.showHeader;
                document.getElementById('confShowWatermark').checked = state.showWatermark;
                
                if (state.logo) {
                    document.getElementById('confLogoPreview').src = state.logo;
                    document.getElementById('confLogoPreview').classList.remove('hidden');
                    document.getElementById('confLogoPlaceholder').classList.add('hidden');
                } else {
                    document.getElementById('confLogoPreview').classList.add('hidden');
                    document.getElementById('confLogoPlaceholder').classList.remove('hidden');
                }

                renderConfProductList();
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        function renderConfProductList() {
            const list = document.getElementById('confProductList');
            list.innerHTML = '';
            state.products.forEach((p, index) => {
                const item = document.createElement('div');
                item.className = "flex justify-between items-center bg-white/30 p-2 rounded";
                item.innerHTML = `
                    <span class="font-typewriter text-sm">${p.name} ($${p.price})</span>
                    <button onclick="removeProduct(${index})" class="text-red-700 hover:bg-red-100 p-1 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                `;
                list.appendChild(item);
            });
            lucide.createIcons();
        }

        function handleLogoUpload(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    state.logo = e.target.result;
                    document.getElementById('confLogoPreview').src = state.logo;
                    document.getElementById('confLogoPreview').classList.remove('hidden');
                    document.getElementById('confLogoPlaceholder').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function removeLogo() {
            state.logo = null;
            document.getElementById('confLogoPreview').classList.add('hidden');
            document.getElementById('confLogoPlaceholder').classList.remove('hidden');
            document.getElementById('logoInput').value = "";
        }

        function addProduct() {
            const name = document.getElementById('newProdName').value;
            const price = parseFloat(document.getElementById('newProdPrice').value);
            const cat = document.getElementById('newProdCat').value;
            
            if (name && !isNaN(price)) {
                state.products.push({
                    id: Date.now().toString(),
                    name,
                    price,
                    category: cat,
                    icon: 'package' // Ícone padrão
                });
                // Limpar
                document.getElementById('newProdName').value = '';
                document.getElementById('newProdPrice').value = '';
                renderConfProductList();
            }
        }

        function removeProduct(index) {
            state.products.splice(index, 1);
            renderConfProductList();
        }

        function saveSettings() {
            state.storeName = document.getElementById('confStoreName').value;
            state.showHeader = document.getElementById('confShowHeader').checked;
            state.showWatermark = document.getElementById('confShowWatermark').checked;
            
            saveState(); // Salva e re-renderiza a tela principal
            toggleSettings(); // Fecha modal
        }

        function resetFactory() {
            if(confirm("Isso apagará todos os dados e produtos personalizados. Confirmar?")) {
                localStorage.removeItem('saloon_state');
                location.reload();
            }
        }

        // Rodar ao iniciar
        init();

    </script>
</body>
</html>
